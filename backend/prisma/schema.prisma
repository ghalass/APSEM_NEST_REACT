generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================
// üë§ Utilisateur
// ========================
model User {
  id        String    @id @default(uuid()) // UUID pour une meilleure portabilit√©
  firstName String    @map("first_name")
  lastName  String    @map("last_name")
  email     String    @unique
  password  String
  role      Role      @default(USER)
  active    Boolean   @default(true)
  createdAt DateTime? @default(now()) @map("created_at")

  @@map("user")
}

enum Role {
  SUPER_ADMIN
  ADMIN
  USER
  AGENT_SAISIE
}

// ========================
// üèóÔ∏è Site
// ========================
model Site {
  id   String @id @default(uuid())
  name String @unique

  // Relations
  engins    Engin[]
  Saisiehrm Saisiehrm[]
  Objectif  Objectif[]
  Anomalie  Anomalie[]

  @@map("site")
}

// ========================
// üÖøÔ∏è Type de parc
// ========================
model Typeparc {
  id   String @id @default(uuid())
  name String @unique

  // Relations
  parcs Parc[]

  @@map("typeparc")
}

// ========================
// üöú Parc
// ========================
model Parc {
  id                   String                    @id @default(uuid())
  name                 String                    @unique
  typeparcId           String
  engins               Engin[]
  typesConsommationLub TypeconsommationlubParc[]
  typepanneParc        TypepanneParc[]
  lubrifiantParc       LubrifiantParc[]
  Objectif             Objectif[]

  Typeparc Typeparc @relation(fields: [typeparcId], references: [id], onDelete: Restrict)

  @@map("parc")
}

// ========================
// üõ¢Ô∏è Type consommation lubrifiant
// ========================
model Typeconsommationlub {
  id               String                    @id @default(uuid())
  name             String                    @unique
  parcs            TypeconsommationlubParc[]
  Saisielubrifiant Saisielubrifiant[]

  @@map("typeconsommation_lub")
}

// üîó Relation N:N Parc <-> Typeconsommationlub
model TypeconsommationlubParc {
  parcId                String              @map("parc_id")
  typeconsommationlubId String              @map("typeconsommationlub_id")
  parc                  Parc                @relation(fields: [parcId], references: [id], onDelete: Restrict)
  typeconsommationlub   Typeconsommationlub @relation(fields: [typeconsommationlubId], references: [id], onDelete: Restrict)

  @@id([parcId, typeconsommationlubId])
  @@map("typeconsommationlub_parc")
}

// ========================
// üõ¢Ô∏è Lubrifiant <-> Parc
// ========================
model LubrifiantParc {
  parcId       String     @map("parc_id")
  lubrifiantId String     @map("lubrifiant_id")
  parc         Parc       @relation(fields: [parcId], references: [id], onDelete: Restrict)
  lubrifiant   Lubrifiant @relation(fields: [lubrifiantId], references: [id], onDelete: Restrict)

  @@id([parcId, lubrifiantId])
  @@map("lubrifiant_parc")
}

// ========================
// üöú Engin
// ========================
model Engin {
  id                  String  @id @default(uuid())
  name                String  @unique
  active              Boolean @default(true)
  parcId              String
  siteId              String
  initialHeureChassis Float?  @default(0)

  Parc      Parc        @relation(fields: [parcId], references: [id], onDelete: Restrict)
  Site      Site        @relation(fields: [siteId], references: [id], onDelete: Restrict)
  Saisiehrm Saisiehrm[]
  Saisiehim Saisiehim[]
  Anomalie  Anomalie[]

  @@map("engin")
}

// ========================
// ‚öôÔ∏è Type de panne
// ========================
model Typepanne {
  id   String @id @default(uuid())
  name String @unique

  pannes        Panne[]
  TypepanneParc TypepanneParc[]
  Anomalie      Anomalie[]

  @@map("typepanne")
}

// üîó Relation N:N Typepanne <-> Parc
model TypepanneParc {
  parcId      String    @map("parc_id")
  typepanneId String    @map("typepanne_id")
  parc        Parc      @relation(fields: [parcId], references: [id], onDelete: Restrict)
  typepanne   Typepanne @relation(fields: [typepanneId], references: [id], onDelete: Restrict)

  @@id([parcId, typepanneId])
  @@map("typepanne_parc")
}

// ========================
// ‚ö†Ô∏è Panne
// ========================
model Panne {
  id          String @id @default(uuid())
  name        String @unique
  typepanneId String

  Typepanne Typepanne   @relation(fields: [typepanneId], references: [id], onDelete: Restrict)
  Saisiehim Saisiehim[]

  @@map("panne")
}

// ========================
// üïí Saisie HRM
// ========================
model Saisiehrm {
  id      String   @id @default(uuid())
  du      DateTime
  enginId String
  siteId  String
  hrm     Float //ne doit pas d√©passer 24h

  Engin     Engin       @relation(fields: [enginId], references: [id], onDelete: Restrict)
  Site      Site        @relation(fields: [siteId], references: [id], onDelete: Restrict)
  Saisiehim Saisiehim[]

  @@unique([du, enginId])
  @@map("saisie_hrm")
}

// ========================
// üß∞ Saisie HIM
// ========================
model Saisiehim {
  id          String  @id @default(uuid())
  panneId     String
  him         Float
  ni          Int
  saisiehrmId String
  obs         String?
  enginId     String?

  Panne            Panne              @relation(fields: [panneId], references: [id], onDelete: Restrict)
  Saisiehrm        Saisiehrm          @relation(fields: [saisiehrmId], references: [id], onDelete: Restrict)
  Engin            Engin?             @relation(fields: [enginId], references: [id])
  Saisielubrifiant Saisielubrifiant[]

  @@unique([panneId, saisiehrmId])
  @@map("saisie_him")
}

// ========================
// üõ¢Ô∏è Type lubrifiant
// ========================
model Typelubrifiant {
  id   String @id @default(uuid())
  name String @unique

  lubrifiants Lubrifiant[]

  @@map("type_lubrifiant")
}

// ========================
// üõ¢Ô∏è Lubrifiant
// ========================
model Lubrifiant {
  id               String @id @default(uuid())
  name             String @unique
  typelubrifiantId String

  Typelubrifiant   Typelubrifiant     @relation(fields: [typelubrifiantId], references: [id], onDelete: Restrict)
  Saisielubrifiant Saisielubrifiant[]
  LubrifiantParc   LubrifiantParc[]

  @@map("lubrifiant")
}

// ========================
// üß¥ Saisie Lubrifiant
// ========================
model Saisielubrifiant {
  id                    String  @id @default(uuid())
  lubrifiantId          String
  qte                   Float
  obs                   String?
  saisiehimId           String
  typeconsommationlubId String?

  Lubrifiant          Lubrifiant           @relation(fields: [lubrifiantId], references: [id], onDelete: Restrict)
  Saisiehim           Saisiehim            @relation(fields: [saisiehimId], references: [id], onDelete: Restrict)
  Typeconsommationlub Typeconsommationlub? @relation(fields: [typeconsommationlubId], references: [id], onDelete: Restrict)

  @@map("saisie_lubrifiant")
}

// ========================
// üéØ Objectif
// ========================
model Objectif {
  id          String @id @default(uuid())
  annee       Int
  parcId      String
  siteId      String
  dispo       Float?
  mtbf        Float?
  tdm         Float?
  spe_huile   Float?
  spe_go      Float?
  spe_graisse Float?

  Parc Parc @relation(fields: [parcId], references: [id], onDelete: Restrict)
  Site Site @relation(fields: [siteId], references: [id], onDelete: Restrict)

  @@unique([annee, parcId, siteId])
  @@map("objectif")
}

// ==============================
// ENUMS
// ==============================
enum Urgence {
  TRES_ELEVEE
  ELEVEE
  MOYENNE
  FAIBLE
}

enum Source {
  VS
  VJ
  INSPECTION
}

enum Status {
  NON_PROGRAMMEE
  PROGRAMMEE
  PDR_PRET
  ATTENTE_PDR
  EXECUTE
}

enum BesoinStatus {
  ATTENTE_BS
  BS_FAIT
  PDR_SORTIE
  EN_DA
  EN_COMMANDE
  SANS_RESSOURCE
  NON_SUIVI_APPRO
}

// ==============================
// ANOMALIE
// ==============================

model Anomalie {
  id               String    @id @default(uuid())
  enginId          String
  typepanneId      String
  siteId           String
  date_anomalie    DateTime
  description      String
  source           Source
  urgence          Urgence
  equipe_execution String? // optionnel
  obs              String? // optionnel
  status           Status    @default(NON_PROGRAMMEE)
  date_execution   DateTime?

  // Relations
  site       Site        @relation(fields: [siteId], references: [id])
  engin      Engin       @relation(fields: [enginId], references: [id])
  typepanne  Typepanne   @relation(fields: [typepanneId], references: [id])
  besoin_pdr BesoinPdr[]

  @@unique([date_anomalie, description])
}

model BesoinPdr {
  id            String       @id @default(uuid())
  ref           String
  code          String?
  no_bs         String?
  besoin_status BesoinStatus @default(ATTENTE_BS)
  obs           String?
  anomalie_id   String

  // Relation avec Anomalie
  anomalie Anomalie @relation(fields: [anomalie_id], references: [id])

  @@unique([ref, anomalie_id])
}
